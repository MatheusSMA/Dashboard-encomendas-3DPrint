<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Vendas 3D</title>
    <link rel="icon" href="data:,">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f4f6;
        }

        .checkbox-wrapper input:checked+div {
            background-color: #10b981;
            border-color: #10b981;
        }

        .checkbox-wrapper input:checked+div svg {
            display: block;
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .tab-active {
            border-bottom: 4px solid #2563eb;
            color: #1e40af;
            font-weight: bold;
        }

        .tab-inactive {
            color: #6b7280;
        }

        .tab-inactive:hover {
            color: #374151;
        }

        #loadingOverlay {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
        }

        .group-details {
            transition: max-height 0.3s ease-out;
            overflow: hidden;
            max-height: 0;
        }

        .group-open .group-details {
            max-height: 2000px;
            transition: max-height 0.5s ease-in;
        }

        .qty-btn {
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            background-color: #e5e7eb;
            color: #374151;
            user-select: none;
        }

        .qty-btn:hover {
            background-color: #d1d5db;
        }

        .status-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 9999px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .status-waiting {
            background-color: #f3f4f6;
            color: #6b7280;
            border: 1px solid #d1d5db;
        }

        .status-printing {
            background-color: #fff7ed;
            color: #c2410c;
            border: 1px solid #fed7aa;
        }

        .status-done {
            background-color: #eff6ff;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        .card-img-container {
            width: 100%;
            padding-top: 100%;
            position: relative;
            background-color: #f9fafb;
            overflow: hidden;
            cursor: pointer;
        }

        .card-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .card-img:hover {
            transform: scale(1.05);
        }

        .color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            border: 1px solid rgba(0, 0, 0, 0.1);
            margin-right: 5px;
            vertical-align: middle;
        }

        #carouselModal {
            background-color: rgba(0, 0, 0, 0.95);
        }

        .carousel-img {
            max-height: 80vh;
            max-width: 90vw;
            object-fit: contain;
        }

        .filament-progress {
            height: 6px;
            border-radius: 3px;
            background-color: #e5e7eb;
            overflow: hidden;
            margin-top: 4px;
        }

        .filament-bar {
            height: 100%;
            transition: width 0.5s ease;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col relative">

    <div id="loadingOverlay"
        class="fixed inset-0 z-50 hidden flex flex-col items-center justify-center transition-opacity duration-300">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
        <p class="text-blue-800 font-bold text-lg uppercase tracking-wider" id="loadingText">Conectando ao Banco de
            Dados...</p>
    </div>

    <!-- Carousel Modal -->
    <div id="carouselModal" class="fixed inset-0 z-[60] hidden flex flex-col items-center justify-center">
        <button onclick="closeCarousel()"
            class="absolute top-4 right-4 text-white text-3xl hover:text-gray-300 z-[70]">&times;</button>
        <div class="relative w-full h-full flex items-center justify-center">
            <button onclick="prevImage()"
                class="absolute left-2 sm:left-8 text-white text-4xl hover:text-gray-300 p-4 z-[70] bg-black bg-opacity-20 rounded-full h-16 w-16 flex items-center justify-center">&#10094;</button>
            <img id="carouselImage" src="" class="carousel-img shadow-2xl rounded-lg">
            <button onclick="nextImage()"
                class="absolute right-2 sm:right-8 text-white text-4xl hover:text-gray-300 p-4 z-[70] bg-black bg-opacity-20 rounded-full h-16 w-16 flex items-center justify-center">&#10095;</button>
        </div>
        <div class="absolute bottom-8 flex gap-2" id="carouselIndicators"></div>
        <p id="carouselCaption" class="absolute bottom-4 text-white font-medium text-lg"></p>
    </div>

    <nav class="bg-white shadow-md z-10 sticky top-0">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 text-white p-2 rounded-lg">
                        <i class="fas fa-cube"></i>
                    </div>
                    <div class="flex flex-col">
                        <span class="font-bold text-xl text-gray-800 leading-tight hidden sm:block">Gerenciador
                            3D</span>
                        <span id="cloudStatus"
                            class="text-[10px] font-bold text-blue-500 uppercase tracking-wide flex items-center gap-1">
                            <i class="fas fa-wifi"></i> Online
                        </span>
                    </div>
                </div>
                <div class="flex space-x-2 sm:space-x-4 overflow-x-auto no-scrollbar">
                    <button onclick="switchTab('sales')" id="tab-sales"
                        class="tab-active py-4 px-2 transition-colors flex items-center gap-2 text-sm sm:text-base whitespace-nowrap">
                        <i class="fas fa-cash-register"></i> <span class="hidden sm:inline">Vendas</span>
                    </button>
                    <button onclick="switchTab('models')" id="tab-models"
                        class="tab-inactive py-4 px-2 transition-colors flex items-center gap-2 text-sm sm:text-base whitespace-nowrap">
                        <i class="fas fa-shapes"></i> <span class="hidden sm:inline">Modelos</span>
                    </button>
                    <button onclick="switchTab('filaments')" id="tab-filaments"
                        class="tab-inactive py-4 px-2 transition-colors flex items-center gap-2 text-sm sm:text-base whitespace-nowrap">
                        <i class="fas fa-circle-notch"></i> <span class="hidden sm:inline">Filamentos</span>
                    </button>
                    <button onclick="switchTab('dashboard')" id="tab-dashboard"
                        class="tab-inactive py-4 px-2 transition-colors flex items-center gap-2 text-sm sm:text-base whitespace-nowrap">
                        <i class="fas fa-chart-pie"></i> <span class="hidden sm:inline">Gráficos</span>
                    </button>
                    <button onclick="switchTab('settings')" id="tab-settings"
                        class="tab-inactive py-4 px-2 transition-colors flex items-center gap-2 text-sm sm:text-base whitespace-nowrap">
                        <i class="fas fa-save"></i> <span class="hidden sm:inline">Dados</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto w-full p-4 sm:p-6 flex-grow">

        <!-- VIEW: VENDAS -->
        <div id="view-sales" class="view-section">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white p-5 rounded-lg shadow border border-gray-200">
                        <h2 class="font-bold text-gray-700 mb-4 border-b pb-2"><i
                                class="fas fa-cart-plus mr-2 text-blue-600"></i>Nova Venda</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-gray-500 block mb-1">Cliente</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400"><i
                                            class="fas fa-user"></i></span>
                                    <input type="text" id="saleCustomer" list="customerList"
                                        placeholder="Nome do Cliente (opcional)"
                                        class="w-full pl-9 p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                                    <datalist id="customerList"></datalist>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 block mb-1">Modelo / Produto</label>
                                <div class="flex gap-2">
                                    <div id="saleProductImg"
                                        class="w-10 h-10 bg-gray-100 rounded border flex-shrink-0 bg-cover bg-center cursor-pointer"
                                        style="background-image: none;" onclick="openSaleProductCarousel()"></div>
                                    <div class="w-full">
                                        <select id="productDropdown" onchange="updateSaleInput()"
                                            class="w-full p-2 border rounded bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none mb-2">
                                            <option value="">Carregando...</option>
                                        </select>
                                        <!-- VARIATION DROPDOWN (Hidden by default) -->
                                        <select id="saleVariation" onchange="updateSaleInputFromVariation()"
                                            class="w-full p-2 border border-blue-200 rounded bg-blue-50 focus:ring-2 focus:ring-blue-500 outline-none text-sm hidden">
                                            <option value="">Padrão</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- NOVO: Seletor de Filamento da Venda -->
                            <div>
                                <label class="text-xs font-bold text-gray-500 block mb-1 flex justify-between">
                                    Filamento desta Produção
                                    <span class="text-[10px] text-blue-500 font-normal" id="saleCostPreview">Custo: R$
                                        0,00</span>
                                </label>
                                <select id="saleFilament" onchange="recalcSaleCost()"
                                    class="w-full p-2 border rounded bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                                    <option value="">Selecione o filamento...</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 block mb-1">Qtd</label>
                                    <input type="number" id="saleQty" value="1" min="1"
                                        class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none text-center">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500 block mb-1">Preço Vendido
                                        (Unit.)</label>
                                    <input type="number" id="finalSalePrice" step="0.01" placeholder="0,00"
                                        class="w-full p-2 border rounded focus:ring-2 focus:ring-green-500 outline-none bg-white font-bold text-gray-700">
                                </div>
                            </div>

                            <!-- Campos Ocultos -->
                            <input type="hidden" id="calculatedSaleCost" value="0">
                            <input type="hidden" id="calculatedSaleEnergy" value="0">
                            <input type="hidden" id="selectedVariationName" value="">

                            <button onclick="addSale()"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded transition shadow-md flex justify-center items-center gap-2 mt-2">
                                <i class="fas fa-plus"></i> Registrar Venda
                            </button>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-lg shadow border border-yellow-200 relative">
                        <div
                            class="absolute top-0 right-0 bg-yellow-100 text-yellow-800 text-[10px] font-bold px-2 py-1 rounded-bl-lg uppercase">
                            Simulação Rápida</div>
                        <h2 class="font-bold text-gray-700 mb-4 border-b pb-2 text-sm"><i
                                class="fas fa-calculator mr-2 text-yellow-600"></i>Orçamento Rápido</h2>
                        <div class="space-y-3 text-sm">
                            <div>
                                <label class="text-xs font-bold text-gray-500 block mb-1">Filamento Utilizado</label>
                                <select id="calcFilamentSelect" onchange="calculateCost()"
                                    class="w-full p-2 border rounded text-sm bg-gray-50 focus:ring-2 focus:ring-yellow-400 outline-none">
                                    <option value="">Carregando filamentos...</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs text-gray-500 block mb-1">Peso (g)</label>
                                    <input type="number" id="calcWeight" placeholder="Ex: 45"
                                        class="w-full p-2 border rounded text-center text-sm" oninput="calculateCost()">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 block mb-1">Tempo (H:M:S)</label>
                                    <div class="flex gap-1 items-center">
                                        <input type="number" id="timeH" placeholder="H"
                                            class="w-full p-2 border rounded text-center text-sm"
                                            oninput="calculateCost()">
                                        <input type="number" id="timeM" placeholder="M"
                                            class="w-full p-2 border rounded text-center text-sm"
                                            oninput="calculateCost()">
                                        <input type="number" id="timeS" placeholder="S"
                                            class="w-full p-2 border rounded text-center text-sm"
                                            oninput="calculateCost()">
                                    </div>
                                </div>
                            </div>
                            <div
                                class="bg-gray-100 p-3 rounded border border-gray-200 flex justify-between items-center">
                                <span class="text-xs text-gray-500">Custo Base:</span>
                                <span id="displayTotalCost" class="font-bold text-gray-700">R$ 0,00</span>
                            </div>
                            <div
                                class="bg-green-50 p-3 rounded border border-green-200 flex justify-between items-center">
                                <span class="text-xs text-green-700 font-bold">Venda Sugerida (100%):</span>
                                <span id="displaySuggestedPrice" class="font-bold text-green-700 text-lg">R$ 0,00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden h-full flex flex-col">
                        <div class="bg-gray-50 p-4 border-b flex justify-between items-center flex-wrap gap-2">
                            <div class="flex items-center gap-2">
                                <h2 class="font-bold text-gray-700"><i class="fas fa-list mr-2"></i>Histórico</h2>
                                <button onclick="toggleViewMode()" id="btnViewMode"
                                    class="text-xs bg-white border border-gray-300 hover:bg-gray-100 px-3 py-1 rounded-full transition shadow-sm flex items-center gap-1">
                                    <i class="fas fa-users"></i> Agrupar por Cliente
                                </button>
                            </div>
                            <div class="text-right w-full sm:w-auto">
                                <span class="text-xs text-gray-500 block">Lucro Recebido Total</span>
                                <span id="totalProfitDisplay" class="font-bold text-green-600 text-lg">R$ 0,00</span>
                            </div>
                        </div>
                        <div id="salesListContainer" class="overflow-x-auto flex-grow bg-gray-50 p-2"></div>
                        <div id="emptyState" class="p-12 text-center text-gray-400 hidden">
                            <i class="fas fa-clipboard-list text-5xl mb-3 text-gray-200"></i>
                            <p>Nenhuma venda registrada.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: MODELOS -->
        <div id="view-models" class="view-section hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1">
                    <div class="bg-white p-5 rounded-lg shadow border border-gray-200 sticky top-24">
                        <h2 class="font-bold text-gray-700 mb-4 border-b pb-2 flex justify-between items-center">
                            <span id="formTitle"><i class="fas fa-plus-circle mr-2 text-green-600"></i>Novo
                                Modelo</span>
                            <button onclick="resetModelForm()" id="btnCancelEdit"
                                class="hidden text-xs text-red-500 hover:underline">Cancelar</button>
                        </h2>
                        <input type="hidden" id="editModelId">
                        <input type="hidden" id="regProdEnergyCost">

                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-gray-500 block mb-1">Nome do Modelo</label>
                                <input type="text" id="regProdName" placeholder="Ex: Charmander"
                                    class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>

                            <!-- Upload de Imagem -->
                            <div class="mb-4">
                                <label class="text-xs font-bold text-gray-500 block mb-1">Fotos do Produto</label>
                                <div class="relative w-full h-32 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 flex flex-col items-center justify-center overflow-hidden hover:border-blue-400 transition cursor-pointer"
                                    onclick="document.getElementById('modelImageInput').click()">
                                    <div class="text-gray-400 flex flex-col items-center">
                                        <i class="fas fa-camera text-2xl mb-1"></i>
                                        <p class="text-[10px]">Adicionar Foto</p>
                                    </div>
                                </div>
                                <input type="file" id="modelImageInput" accept="image/*" class="hidden"
                                    onchange="handleImageUpload(this)">
                                <div id="imageGalleryPreview" class="flex gap-2 mt-2 overflow-x-auto pb-2"></div>
                            </div>

                            <!-- CALCULADORA DE CUSTO (INTEGRADA) -->
                            <div class="bg-blue-50 p-4 rounded border border-blue-100 shadow-sm">
                                <p class="text-xs font-bold text-blue-800 mb-3 uppercase flex items-center gap-2">
                                    <i class="fas fa-calculator"></i> Definição de Custo de Produção
                                </p>
                                <div class="mb-3">
                                    <label class="text-xs font-bold text-gray-500 block mb-1">Filamento Utilizado
                                        (Ref.)</label>
                                    <select id="regProdFilament"
                                        class="w-full p-2 border rounded text-xs bg-white focus:ring-1 focus:ring-blue-400"
                                        onchange="calculateModelFormCost()">
                                        <option value="">Selecione...</option>
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-3 mb-2">
                                    <div>
                                        <label class="text-xs font-bold text-gray-500 block mb-1">Peso (g)</label>
                                        <input type="number" id="regProdWeight"
                                            class="w-full p-2 border rounded bg-white text-center" placeholder="0"
                                            oninput="calculateModelFormCost()">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-gray-500 block mb-1">Tempo (H:M)</label>
                                        <div class="flex gap-1">
                                            <input type="number" id="regProdTimeH"
                                                class="w-full p-2 border rounded bg-white text-center" placeholder="H"
                                                oninput="calculateModelFormCost()">
                                            <input type="number" id="regProdTimeM"
                                                class="w-full p-2 border rounded bg-white text-center" placeholder="M"
                                                oninput="calculateModelFormCost()">
                                        </div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3 mt-3 pt-3 border-t border-blue-200">
                                    <div>
                                        <label class="text-[10px] font-bold text-gray-500 block">Custo Estimado</label>
                                        <input type="text" id="calcPreviewCost"
                                            class="w-full p-1 bg-transparent border-none font-bold text-lg text-gray-800 focus:ring-0"
                                            readonly value="R$ 0,00">
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-gray-400 block">Energia (Est.)</label>
                                        <input type="text" id="calcPreviewEnergy"
                                            class="w-full p-1 bg-transparent border-none text-sm text-gray-500 focus:ring-0"
                                            readonly value="R$ 0,00">
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-3 mt-4">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 block mb-1">Custo Final (R$)</label>
                                    <input type="number" id="regProdCost" step="0.01" placeholder="0,00"
                                        class="w-full p-2 border rounded bg-gray-50 outline-none font-bold text-gray-700">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500 block mb-1">Venda Sugerida
                                        (R$)</label>
                                    <input type="number" id="regProdPrice" step="0.01" placeholder="0,00"
                                        class="w-full p-2 border rounded outline-none">
                                </div>
                            </div>

                            <div class="bg-yellow-50 p-2 rounded border border-yellow-100">
                                <label class="text-xs font-bold text-yellow-800 block mb-1">Custo Energia (Incluso no
                                    Total)</label>
                                <input type="number" id="displayEnergyCost" step="0.0001" placeholder="0,00"
                                    class="w-full p-2 border border-yellow-200 rounded text-sm bg-white outline-none">
                            </div>

                            <button onclick="saveProduct()" id="btnSaveModel"
                                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded transition shadow-md mt-2">
                                Salvar Modelo
                            </button>

                            <!-- SEÇÃO DE VARIAÇÕES -->
                            <hr class="border-gray-200 my-4">
                            <div class="bg-gray-50 p-3 rounded border border-gray-200">
                                <div class="flex justify-between items-center mb-2">
                                    <p class="text-xs font-bold text-gray-500 uppercase"><i
                                            class="fas fa-code-branch"></i> Variações (Submodelos)</p>
                                    <button onclick="addVariationRow()"
                                        class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600"><i
                                            class="fas fa-plus"></i> Add</button>
                                </div>
                                <div id="variationsContainer" class="space-y-2">
                                    <!-- Variation Rows will be added here -->
                                </div>
                                <p class="text-[10px] text-gray-400 mt-2">Adicione tamanhos ou estilos diferentes. O
                                    custo será calculado com base no filamento selecionado acima.</p>
                            </div>

                            <hr class="border-gray-200 my-4">
                            <div class="bg-gray-50 p-3 rounded border border-gray-200">
                                <p class="text-xs font-bold text-gray-500 mb-2 uppercase"><i class="fas fa-cog"></i>
                                    Configs Globais</p>
                                <div class="grid grid-cols-2 gap-2 text-xs">
                                    <div><label>Filamento Padrão (R$/kg)</label><input type="number" id="cfgFilament"
                                            class="w-full p-1 border rounded" onchange="saveConfig()"></div>
                                    <div><label>Energia (R$/kWh)</label><input type="number" id="cfgEnergy"
                                            class="w-full p-1 border rounded" onchange="saveConfig()"></div>
                                    <div class="col-span-2"><label>Potência (W)</label><input type="number"
                                            id="cfgPower" class="w-full p-1 border rounded" onchange="saveConfig()">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 p-4 border-b flex justify-between items-center">
                            <h2 class="font-bold text-gray-700">Meus Modelos</h2>
                            <button onclick="toggleModelsView()" id="btnModelsView"
                                class="text-xs bg-white border border-gray-300 hover:bg-gray-100 px-3 py-1 rounded transition shadow-sm">
                                <i class="fas fa-th-large"></i> Ver Cards
                            </button>
                        </div>
                        <div id="modelsContainer" class="p-2">
                            <!-- JS renderiza lista ou grid aqui -->
                        </div>
                        <div id="emptyModels" class="p-8 text-center text-gray-400 hidden">
                            Nenhum modelo cadastrado.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: FILAMENTOS -->
        <div id="view-filaments" class="view-section hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1">
                    <div class="bg-white p-5 rounded-lg shadow border border-gray-200">
                        <h2 class="font-bold text-gray-700 mb-4 border-b pb-2"><i
                                class="fas fa-circle-notch mr-2 text-purple-600"></i>Novo Filamento</h2>
                        <input type="hidden" id="editFilamentId">
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-gray-500 block mb-1">Nome / Marca</label>
                                <input type="text" id="regFilName" placeholder="Ex: PLA Preto Voolt"
                                    class="w-full p-2 border rounded focus:ring-2 focus:ring-purple-500 outline-none">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 block mb-1">Preço do Kg (R$)</label>
                                    <input type="number" id="regFilPrice" step="0.01" placeholder="0,00"
                                        class="w-full p-2 border rounded bg-gray-50 outline-none">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500 block mb-1">Cor (Opcional)</label>
                                    <input type="color" id="regFilColor" value="#000000"
                                        class="w-full h-10 p-1 border rounded cursor-pointer">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 block mb-1">Peso Total Carretel
                                        (g)</label>
                                    <input type="number" id="regFilWeight" value="1000"
                                        class="w-full p-2 border rounded bg-gray-50 outline-none">
                                </div>
                            </div>
                            <button onclick="saveFilament()" id="btnSaveFilament"
                                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded transition">Salvar
                                Filamento</button>
                            <button onclick="resetFilamentForm()" id="btnCancelFilEdit"
                                class="w-full text-xs text-red-500 hover:underline hidden mt-2">Cancelar Edição</button>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 p-4 border-b">
                            <h2 class="font-bold text-gray-700">Meus Filamentos (Estoque)</h2>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3">Cor</th>
                                        <th class="px-4 py-3">Nome</th>
                                        <th class="px-4 py-3 text-right">Preço/Kg</th>
                                        <th class="px-4 py-3 text-center">Estoque</th>
                                        <th class="px-4 py-3 text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="filamentsTableBody"></tbody>
                            </table>
                            <div id="emptyFilaments" class="p-8 text-center text-gray-400 hidden">Nenhum filamento
                                cadastrado.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="view-section hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
                    <p class="text-xs text-gray-500 uppercase font-bold">Faturamento</p>
                    <p id="kpiRevenue" class="text-2xl font-bold text-gray-800">R$ 0,00</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
                    <p class="text-xs text-gray-500 uppercase font-bold">Lucro Líquido</p>
                    <p id="kpiProfit" class="text-2xl font-bold text-green-600">R$ 0,00</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-red-400">
                    <p class="text-xs text-gray-500 uppercase font-bold">Custos</p>
                    <p id="kpiCost" class="text-2xl font-bold text-red-500">R$ 0,00</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-yellow-500">
                    <p class="text-xs text-gray-500 uppercase font-bold">Energia (Est.)</p>
                    <p id="kpiEnergy" class="text-xl font-bold text-yellow-600">R$ 0,00</p>
                    <p id="kpiEnergyKwh" class="text-[10px] text-gray-400">0 kWh</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow border-l-4 border-purple-500">
                    <p class="text-xs text-gray-500 uppercase font-bold">Vendas (Itens)</p>
                    <p id="kpiCount" class="text-2xl font-bold text-purple-600">0</p>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="h-64"><canvas id="chartFinance"></canvas></div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="h-64"><canvas id="chartProducts"></canvas></div>
                </div>
            </div>
        </div>

        <!-- VIEW: DADOS -->
        <div id="view-settings" class="view-section hidden">
            <div class="max-w-2xl mx-auto space-y-6">
                <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
                    <h2 class="font-bold text-lg text-gray-800 mb-4"><i class="fas fa-hdd mr-2"></i>Backup Manual</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="exportData()"
                            class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-2 rounded text-sm">Baixar
                            Arquivo JSON</button>
                        <div class="relative"><input type="file" id="importFile" accept=".json"
                                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                onchange="importData()" /><button
                                class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 rounded text-sm pointer-events-none">Restaurar
                                de Arquivo</button></div>
                    </div>
                </div>
                <div class="bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                    <h2 class="font-bold text-lg text-yellow-800 mb-2"><i class="fas fa-bolt mr-2"></i>Reparar Histórico
                    </h2>
                    <button onclick="recalculateEnergyHistory()"
                        class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded text-sm transition">Atualizar
                        Histórico Agora</button>
                </div>
                <div class="bg-red-50 p-6 rounded-lg border border-red-200 text-center mt-8">
                    <button onclick="clearAllData()"
                        class="text-red-600 border border-red-600 hover:bg-red-600 hover:text-white font-bold py-2 px-6 rounded transition text-sm">Resetar
                        Tudo</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_SHEETS_URL = "https://script.google.com/macros/s/AKfycbwu1W_8GWcS-b7XzQrzDpgZjFDebqtmoyj3Htc8gCQQptxufyI2hgBmFek_zrmXonpbGg/exec";
        let products = []; let sales = []; let filaments = [];
        let settings = { filamentPrice: '', energyRate: '', printerPower: '' };
        let cloudUrl = GOOGLE_SHEETS_URL || localStorage.getItem('3d_cloud_url') || '';
        let viewMode = 'table'; let viewModeModels = 'list';
        let chartFinanceInstance = null; let chartProductsInstance = null;
        let currentModelImages = []; let currentModelImagesLoaded = false;
        let currentVariations = []; // To store variations during edit

        document.addEventListener('DOMContentLoaded', () => {
            // REMOVE LOAD LOCAL, FORCE CLOUD
            const cfgFilament = document.getElementById('cfgFilament');
            if (cfgFilament) cfgFilament.value = settings.filamentPrice;
            document.getElementById('cfgEnergy').value = settings.energyRate;
            document.getElementById('cfgPower').value = settings.printerPower;
            renderFilamentsTable(); updateFilamentDropdown(); renderFilamentOptionsForModel();

            // FORCE LOAD FROM CLOUD ALWAYS
            if (cloudUrl) syncFromCloud(true);
            else {
                alert("URL não configurada no código.");
                refreshUI(); // Show empty UI
            }
        });

        function refreshUI() {
            updateDropdown(); updateCustomerDatalist(); renderSalesTable(); renderModelsTable(); renderFilamentsTable();
            updateFilamentDropdown(); renderFilamentOptionsForModel(); updateKPIs();
        }

        let currentCarouselImages = []; let currentCarouselIndex = 0;
        function openCarousel(imgs, cap) { if (!imgs || imgs.length === 0) return; currentCarouselImages = imgs; currentCarouselIndex = 0; updateCarouselView(); document.getElementById('carouselCaption').textContent = cap || ''; document.getElementById('carouselModal').classList.remove('hidden'); }
        function closeCarousel() { document.getElementById('carouselModal').classList.add('hidden'); }
        function nextImage() { currentCarouselIndex = (currentCarouselIndex + 1) % currentCarouselImages.length; updateCarouselView(); }
        function prevImage() { currentCarouselIndex = (currentCarouselIndex - 1 + currentCarouselImages.length) % currentCarouselImages.length; updateCarouselView(); }
        function updateCarouselView() { const img = document.getElementById('carouselImage'); img.src = currentCarouselImages[currentCarouselIndex]; const dots = document.getElementById('carouselIndicators'); dots.innerHTML = ''; if (currentCarouselImages.length > 1) { currentCarouselImages.forEach((_, i) => { const d = document.createElement('div'); d.className = `w-3 h-3 rounded-full cursor-pointer ${i === currentCarouselIndex ? 'bg-white' : 'bg-gray-500'}`; d.onclick = () => { currentCarouselIndex = i; updateCarouselView(); }; dots.appendChild(d); }); } }
        function openProductCarousel(id) { const p = products.find(x => x.id == id); if (p && p.images && p.images.length > 0) openCarousel(p.images, p.name); }
        function openSaleProductCarousel() { const id = document.getElementById('productDropdown').value; if (id) openProductCarousel(id); }

        function saveFilament() { const id = document.getElementById('editFilamentId').value; const name = document.getElementById('regFilName').value; const price = parseFloat(document.getElementById('regFilPrice').value); const color = document.getElementById('regFilColor').value; const weight = parseFloat(document.getElementById('regFilWeight').value) || 1000; if (!name || isNaN(price)) { alert("Preencha nome e preço"); return; } if (id) { const idx = filaments.findIndex(f => f.id == id); if (idx !== -1) filaments[idx] = { ...filaments[idx], name, price, color }; } else { filaments.push({ id: Date.now(), name, price, color, initialWeight: weight, remainingWeight: weight }); } saveData(); resetFilamentForm(); renderFilamentsTable(); updateFilamentDropdown(); renderFilamentOptionsForModel(); }
        function editFilament(id) { const f = filaments.find(x => x.id == id); if (!f) return; document.getElementById('regFilName').value = f.name; document.getElementById('regFilPrice').value = f.price; document.getElementById('regFilColor').value = f.color; document.getElementById('regFilWeight').value = f.initialWeight || 1000; document.getElementById('editFilamentId').value = f.id; document.getElementById('btnSaveFilament').textContent = "Atualizar"; document.getElementById('btnCancelFilEdit').classList.remove('hidden'); }
        function deleteFilament(id) { if (confirm("Excluir?")) { filaments = filaments.filter(f => f.id != id); saveData(); renderFilamentsTable(); updateFilamentDropdown(); renderFilamentOptionsForModel(); } }
        function manualAdjustFilament(id) { const f = filaments.find(x => x.id == id); if (!f) return; const a = parseFloat(prompt("Descontar peso (g):", "0")); if (!isNaN(a) && a > 0) { f.remainingWeight = Math.max(0, (f.remainingWeight || f.initialWeight) - a); saveData(); renderFilamentsTable(); alert("Estoque atualizado."); } }
        function resetFilamentForm() { document.getElementById('regFilName').value = ''; document.getElementById('regFilPrice').value = ''; document.getElementById('regFilColor').value = '#000000'; document.getElementById('regFilWeight').value = '1000'; document.getElementById('editFilamentId').value = ''; document.getElementById('btnSaveFilament').textContent = "Salvar Filamento"; document.getElementById('btnCancelFilEdit').classList.add('hidden'); }
        function renderFilamentsTable() { const b = document.getElementById('filamentsTableBody'); b.innerHTML = ''; if (!filaments.length) { document.getElementById('emptyFilaments').classList.remove('hidden'); return; } document.getElementById('emptyFilaments').classList.add('hidden'); filaments.forEach(f => { const i = f.initialWeight || 1000; const r = f.remainingWeight !== undefined ? f.remainingWeight : i; const p = Math.max(0, Math.min(100, (r / i) * 100)); const c = p < 20 ? 'bg-red-600' : (p < 50 ? 'bg-yellow-500' : 'bg-blue-600'); b.insertAdjacentHTML('beforeend', `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-4 py-3 text-center"><div class="color-dot" style="background-color:${f.color}"></div></td><td class="px-4 py-3 font-medium text-gray-900">${f.name}<div class="text-xs text-gray-400 font-normal">Início: ${i}g</div></td><td class="px-4 py-3 text-right text-gray-500">${formatMoney(f.price)}</td><td class="px-4 py-3 text-center w-32"><div class="text-xs font-bold text-gray-700 mb-1">${r.toFixed(0)}g</div><div class="filament-progress"><div class="filament-bar ${c}" style="width:${p}%"></div></div></td><td class="px-4 py-3 text-center space-x-1"><button onclick="manualAdjustFilament('${f.id}')" class="text-yellow-600 hover:text-yellow-800"><i class="fas fa-minus-circle"></i></button><button onclick="editFilament('${f.id}')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button><button onclick="deleteFilament('${f.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button></td></tr>`); }); }
        function updateFilamentDropdown() { const d = document.getElementById('calcFilamentSelect'); if (!d) return; d.innerHTML = '<option value="">Selecione...</option>'; filaments.forEach(f => { const o = document.createElement('option'); o.value = f.id; o.textContent = `${f.name} (${formatMoney(f.price)}/kg)`; d.appendChild(o); }); if (settings.filamentPrice) { const o = document.createElement('option'); o.value = 'default'; o.textContent = `Padrão (${formatMoney(settings.filamentPrice)}/kg)`; d.appendChild(o); } }
        function renderFilamentOptionsForModel() { const d = document.getElementById('regProdFilament'); if (!d) return; d.innerHTML = '<option value="">Selecione...</option>'; filaments.forEach(f => { const o = document.createElement('option'); o.value = f.id; o.textContent = `${f.name} (${formatMoney(f.price)}/kg)`; d.appendChild(o); }); if (settings.filamentPrice) { const o = document.createElement('option'); o.value = 'default'; o.textContent = `Padrão (${formatMoney(settings.filamentPrice)}/kg)`; d.appendChild(o); } }

        function calculateModelFormCost() {
            const w = parseFloat(document.getElementById('regProdWeight').value) || 0; const th = parseFloat(document.getElementById('regProdTimeH').value) || 0; const tm = parseFloat(document.getElementById('regProdTimeM').value) || 0;
            const fid = document.getElementById('regProdFilament').value; if (w === 0 && th === 0 && tm === 0) return;
            let fp = parseFloat(settings.filamentPrice) || 0; if (fid && fid !== 'default') { const f = filaments.find(x => x.id == fid); if (f) fp = f.price; }
            const ep = parseFloat(settings.energyRate) || 0; const pow = parseFloat(settings.printerPower) || 0;
            const mat = (fp / 1000) * w; const hrs = th + (tm / 60); const en = ((ep * pow) / 1000) * hrs; const tot = mat + en;
            document.getElementById('regProdCost').value = tot.toFixed(2); document.getElementById('regProdEnergyCost').value = en.toFixed(4); document.getElementById('displayEnergyCost').value = en.toFixed(4); document.getElementById('calcPreviewCost').value = formatMoney(tot); document.getElementById('calcPreviewEnergy').value = formatMoney(en);
        }

        // --- VARIATIONS LOGIC ---
        function addVariationRow(data = {}) {
            const id = data.id || Date.now().toString(36) + Math.random().toString(36).substr(2);
            const name = data.name || "";
            const weight = data.weight || "";
            const timeH = data.timeH || "";
            const timeM = data.timeM || "";
            const price = data.price || "";

            // Add to array
            const variation = { id, name, weight, timeH, timeM, price };
            if (!data.id) currentVariations.push(variation); // Only push if new

            renderVariationsList();
        }

        function removeVariation(id) {
            currentVariations = currentVariations.filter(v => v.id !== id);
            renderVariationsList();
        }

        function updateVariationData(id, field, value) {
            const idx = currentVariations.findIndex(v => v.id === id);
            if (idx !== -1) {
                currentVariations[idx][field] = value;
            }
        }

        function renderVariationsList() {
            const container = document.getElementById('variationsContainer');
            container.innerHTML = "";

            currentVariations.forEach(v => {
                const div = document.createElement('div');
                div.className = "flex flex-wrap gap-2 items-end bg-white p-2 border rounded shadow-sm relative";
                div.innerHTML = `
                     <div class="flex-1 min-w-[120px]">
                         <label class="text-[10px] text-gray-500">Nome (ex: 50%)</label>
                         <input type="text" value="${v.name}" oninput="updateVariationData('${v.id}', 'name', this.value)" class="w-full p-1 border rounded text-xs">
                     </div>
                     <div class="w-16">
                         <label class="text-[10px] text-gray-500">Peso(g)</label>
                         <input type="number" value="${v.weight}" oninput="updateVariationData('${v.id}', 'weight', this.value)" class="w-full p-1 border rounded text-xs text-center">
                     </div>
                     <div class="w-20">
                         <label class="text-[10px] text-gray-500">Tempo(H:M)</label>
                         <div class="flex gap-1">
                             <input type="number" value="${v.timeH}" oninput="updateVariationData('${v.id}', 'timeH', this.value)" class="w-full p-1 border rounded text-xs text-center" placeholder="H">
                             <input type="number" value="${v.timeM}" oninput="updateVariationData('${v.id}', 'timeM', this.value)" class="w-full p-1 border rounded text-xs text-center" placeholder="M">
                         </div>
                     </div>
                     <div class="w-20">
                         <label class="text-[10px] text-gray-500">Venda R$</label>
                         <input type="number" value="${v.price}" oninput="updateVariationData('${v.id}', 'price', this.value)" class="w-full p-1 border rounded text-xs text-center font-bold text-green-600">
                     </div>
                     <button onclick="removeVariation('${v.id}')" class="text-red-400 hover:text-red-600 p-1"><i class="fas fa-times"></i></button>
                 `;
                container.appendChild(div);
            });
        }

        // --- IMAGE HANDLING (COMPRESSION) ---
        function handleImageUpload(input) { const f = input.files[0]; if (!f) return; const r = new FileReader(); r.onload = function (e) { const i = new Image(); i.onload = function () { const c = document.createElement('canvas'); const max = 400; let w = i.width; let h = i.height; if (w > max) { h *= max / w; w = max; } c.width = w; c.height = h; const ctx = c.getContext('2d'); ctx.drawImage(i, 0, 0, w, h); const d = c.toDataURL('image/jpeg', 0.6); currentModelImages.push(d); renderImagePreviewList(); input.value = ''; }; i.src = e.target.result; }; r.readAsDataURL(f); }
        function renderImagePreviewList() { const c = document.getElementById('imageGalleryPreview'); c.innerHTML = ''; currentModelImages.forEach((src, i) => { const d = document.createElement('div'); d.className = "relative flex-shrink-0 w-16 h-16 border rounded overflow-hidden group"; d.innerHTML = `<img src="${src}" class="w-full h-full object-cover"><button onclick="removeImage(${i})" class="absolute top-0 right-0 bg-red-500 text-white w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition">&times;</button>`; c.appendChild(d); }); }
        function removeImage(i) { currentModelImages.splice(i, 1); renderImagePreviewList(); }

        function toggleModelsView() { viewModeModels = (viewModeModels === 'list') ? 'grid' : 'list'; const b = document.getElementById('btnModelsView'); if (viewModeModels === 'grid') { b.innerHTML = '<i class="fas fa-list"></i> Ver Lista'; } else { b.innerHTML = '<i class="fas fa-th-large"></i> Ver Cards'; } renderModelsTable(); }
        function renderModelsTable() {
            const c = document.getElementById('modelsContainer'); c.innerHTML = ''; if (!products.length) { document.getElementById('emptyModels').classList.remove('hidden'); return; } document.getElementById('emptyModels').classList.add('hidden');
            if (viewModeModels === 'list') {
                let h = `<div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr><th class="px-4 py-3">Img</th><th class="px-4 py-3">Nome</th><th class="px-4 py-3 text-right">Custo</th><th class="px-4 py-3 text-right">Venda</th><th class="px-4 py-3 text-right">Margem</th><th class="px-4 py-3 text-center">Ações</th></tr></thead><tbody>`;
                products.forEach(p => {
                    const cost = parseFloat(p.cost) || 0; const price = parseFloat(p.price) || 0; const margin = price - cost; const sid = String(p.id).replace(/'/g, "\\'"); const thumb = (p.images && p.images.length > 0) ? p.images[0] : (p.image || ''); const img = thumb ? `<img src="${thumb}" class="w-8 h-8 rounded object-cover border cursor-pointer" onclick="openProductCarousel('${sid}')">` : `<div class="w-8 h-8 bg-gray-200 rounded flex items-center justify-center text-xs"><i class="fas fa-cube text-gray-400"></i></div>`;
                    h += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-4 py-3">${img}</td><td class="px-4 py-3 font-medium text-gray-900">${p.name || 'Sem nome'}</td><td class="px-4 py-3 text-right text-gray-500">${formatMoney(cost)}</td><td class="px-4 py-3 text-right text-gray-500">${formatMoney(price)}</td><td class="px-4 py-3 text-right text-green-600 font-bold">${formatMoney(margin)}</td><td class="px-4 py-3 text-center space-x-2"><button onclick="editModel('${sid}')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button><button onclick="deleteModel('${sid}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button></td></tr>`;
                }); h += `</tbody></table></div>`; c.innerHTML = h;
            } else {
                let h = `<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">`;
                products.forEach(p => {
                    const price = parseFloat(p.price) || 0; const sid = String(p.id).replace(/'/g, "\\'"); const thumb = (p.images && p.images.length > 0) ? p.images[0] : (p.image || ''); const img = thumb ? `<img src="${thumb}" class="card-img">` : `<div class="absolute inset-0 flex items-center justify-center text-gray-300"><i class="fas fa-cube text-4xl"></i></div>`;
                    h += `<div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden flex flex-col"><div class="card-img-container border-b" onclick="openProductCarousel('${sid}')">${img}${(p.images && p.images.length > 1) ? '<div class="absolute bottom-1 right-1 bg-black bg-opacity-50 text-white text-[10px] px-1 rounded"><i class="fas fa-images"></i></div>' : ''}</div><div class="p-3 flex-grow"><h3 class="font-bold text-gray-800 text-sm mb-1 truncate">${p.name}</h3><div class="flex justify-between text-xs mb-2"><span></span><span class="text-green-600 font-bold text-sm">${formatMoney(price)}</span></div></div><div class="bg-gray-50 p-2 flex justify-between border-t"><button onclick="editModel('${sid}')" class="text-blue-500 text-xs font-bold hover:text-blue-700 w-1/2 border-r">EDITAR</button><button onclick="deleteModel('${sid}')" class="text-red-500 text-xs font-bold hover:text-red-700 w-1/2">EXCLUIR</button></div></div>`;
                }); h += `</div>`; c.innerHTML = h;
            }
        }

        // --- SALES ---
        function updateDropdown() { const d = document.getElementById('productDropdown'); d.innerHTML = '<option value="">Selecione...</option>'; if (products.length > 0) products.forEach(p => { const o = document.createElement('option'); o.value = p.id; o.textContent = p.name || "Sem Nome"; d.appendChild(o); }); }
        function updateCustomerDatalist() { const l = document.getElementById('customerList'); l.innerHTML = '';[...new Set(sales.map(s => s.customer || "Consumidor Final"))].forEach(c => { const o = document.createElement('option'); o.value = c; l.appendChild(o); }); }
        function toggleViewMode() { viewMode = (viewMode === 'table') ? 'customer' : 'table'; const b = document.getElementById('btnViewMode'); if (viewMode === 'customer') { b.innerHTML = '<i class="fas fa-list"></i> Lista Simples'; b.classList.add('bg-blue-50', 'text-blue-700', 'border-blue-200'); } else { b.innerHTML = '<i class="fas fa-users"></i> Agrupar por Cliente'; b.classList.remove('bg-blue-50', 'text-blue-700', 'border-blue-200'); } renderSalesTable(); }
        function toggleStatus(id) { const s = sales.find(x => x.id == id); if (s) { const st = ['waiting', 'printing', 'done']; s.status = st[(st.indexOf(s.status || 'waiting') + 1) % st.length]; saveData(); renderSalesTable(); } }
        function getStatusBadge(s) { s = s || 'waiting'; if (s === 'printing') return `<span class="status-badge status-printing"><i class="fas fa-cog fa-spin"></i> Produzindo</span>`; if (s === 'done') return `<span class="status-badge status-done"><i class="fas fa-cube"></i> Pronto</span>`; return `<span class="status-badge status-waiting"><i class="far fa-clock"></i> Espera</span>`; }
        function renderSalesTable() {
            const c = document.getElementById('salesListContainer'); c.innerHTML = ''; if (!sales.length) { document.getElementById('emptyState').classList.remove('hidden'); c.classList.add('hidden'); return; } document.getElementById('emptyState').classList.add('hidden'); c.classList.remove('hidden');
            if (viewMode === 'table') {
                let h = `<table class="w-full text-sm text-left text-gray-500 rounded-lg overflow-hidden"><thead class="text-xs text-gray-700 uppercase bg-gray-200 sticky top-0"><tr><th class="px-4 py-3 whitespace-nowrap">Produto</th><th class="px-4 py-3 text-center">Qtd</th><th class="px-4 py-3 text-right">Total</th><th class="px-4 py-3 text-center">Status</th><th class="px-4 py-3 text-center">Pago</th><th class="px-4 py-3 text-center">Entregue</th><th class="px-4 py-3 text-center">Ação</th></tr></thead><tbody class="bg-white">`;
                [...sales].sort((a, b) => b.id - a.id).forEach(s => {
                    const q = parseInt(s.qty) || 1; const t = (parseFloat(s.price) || 0) * q; const sid = String(s.id).replace(/'/g, "\\'"); const p = products.find(x => x.name === s.name); const th = (p && p.images && p.images.length > 0) ? p.images[0] : (p && p.image ? p.image : ''); const img = th ? `<img src="${th}" class="w-6 h-6 rounded border mr-1 inline-block cursor-pointer" onclick="openProductCarousel('${p ? p.id : ''}')">` : '';
                    h += `<tr class="border-b hover:bg-gray-50"><td class="px-4 py-3"><div class="font-bold text-gray-800 flex items-center gap-1 flex-wrap">${s.customer || "Consumidor Final"}<button onclick="editSaleCustomer('${sid}')" class="text-[10px] text-blue-400 hover:text-blue-600"><i class="fas fa-pen"></i></button></div><div class="text-xs text-gray-500 flex items-center">${img} ${s.name} ${s.variationName ? `<span class="ml-1 bg-gray-200 px-1 rounded text-[9px]">${s.variationName}</span>` : ''}</div></td><td class="px-4 py-3 text-center"><div class="flex items-center justify-center gap-2"><button onclick="updateSaleQty('${sid}',-1)" class="qty-btn">-</button><span class="font-bold text-gray-600 w-4">${q}</span><button onclick="updateSaleQty('${sid}',1)" class="qty-btn">+</button></div></td><td class="px-4 py-3 text-right text-gray-800 font-medium">${formatMoney(t)}</td><td class="px-4 py-3 text-center" onclick="toggleStatus('${sid}')">${getStatusBadge(s.status)}</td><td class="px-4 py-3 text-center"><label class="cursor-pointer inline-flex items-center"><input type="checkbox" class="hidden" onchange="togglePaid('${sid}')" ${s.paid ? 'checked' : ''}><div class="w-5 h-5 border-2 border-gray-300 rounded flex items-center justify-center transition-colors ${s.paid ? 'bg-green-500 border-green-500' : ''}">${s.paid ? '<i class="fas fa-check text-white text-[10px]"></i>' : ''}</div></label></td><td class="px-4 py-3 text-center"><button onclick="toggleDelivered('${sid}')" class="${s.delivered ? 'text-blue-600' : 'text-gray-300 hover:text-gray-400'} transition-colors" title="Entrega"><i class="fas fa-truck"></i></button></td><td class="px-4 py-3 text-center"><button onclick="deleteSale('${sid}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash-alt"></i></button></td></tr>`;
                }); h += `</tbody></table>`; c.innerHTML = h;
            } else {
                const g = {}; sales.forEach(s => { const c = s.customer || "Outros"; if (!g[c]) g[c] = []; g[c].push(s); });
                Object.keys(g).sort().forEach(cus => {
                    const gs = g[cus]; const ti = gs.reduce((s, i) => s + (parseInt(i.qty) || 1), 0); const tv = gs.reduce((s, i) => s + ((parseFloat(i.price) || 0) * (parseInt(i.qty) || 1)), 0); const pe = gs.filter(s => !s.paid).length;
                    let h = `<div class="mb-3 bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden"><div onclick="this.parentElement.classList.toggle('group-open')" class="p-4 bg-white cursor-pointer hover:bg-gray-50 flex justify-between items-center select-none"><div class="flex items-center gap-3"><div class="bg-blue-100 text-blue-600 w-10 h-10 rounded-full flex items-center justify-center font-bold">${cus.charAt(0).toUpperCase()}</div><div><h3 class="font-bold text-gray-800">${cus}</h3><p class="text-xs text-gray-500">${ti} itens • ${formatMoney(tv)}</p></div></div><div class="flex items-center gap-3">${pe > 0 ? `<span class="bg-red-100 text-red-600 text-xs px-2 py-1 rounded-full font-bold">${pe} pendentes</span>` : `<span class="text-green-500 text-xs font-bold"><i class="fas fa-check-circle"></i> OK</span>`}<i class="fas fa-chevron-down text-gray-400 transition-transform duration-300 transform group-open:rotate-180"></i></div></div><div class="group-details bg-gray-50 border-t border-gray-100"><table class="w-full text-xs text-left text-gray-600"><thead class="uppercase bg-gray-100 text-gray-500"><tr><th class="px-4 py-2">Item</th><th class="px-4 py-2 text-center">Qtd</th><th class="px-4 py-2 text-center">Status</th><th class="px-4 py-2 text-center">Pago</th><th class="px-4 py-2 text-center">Del</th><th class="px-4 py-2 text-center">X</th></tr></thead><tbody>`;
                    gs.forEach(s => { const q = parseInt(s.qty) || 1; const sid = String(s.id).replace(/'/g, "\\'"); h += `<tr class="border-b border-gray-100"><td class="px-4 py-2 font-medium">${s.name} ${s.variationName ? `<span class="text-[9px] bg-gray-100 px-1 rounded">${s.variationName}</span>` : ''}</td><td class="px-4 py-2 text-center"><div class="flex items-center justify-center gap-1"><button onclick="updateSaleQty('${sid}',-1)" class="w-4 h-4 bg-gray-200 text-gray-600 rounded flex items-center justify-center font-bold hover:bg-gray-300">-</button><span class="w-3">${q}</span><button onclick="updateSaleQty('${sid}',1)" class="w-4 h-4 bg-gray-200 text-gray-600 rounded flex items-center justify-center font-bold hover:bg-gray-300">+</button></div></td><td class="px-4 py-2 text-center cursor-pointer" onclick="toggleStatus('${sid}')">${getStatusBadge(s.status)}</td><td class="px-4 py-2 text-center cursor-pointer" onclick="togglePaid('${sid}')">${s.paid ? '<span class="text-green-600 font-bold">Sim</span>' : '<span class="text-red-400">Não</span>'}</td><td class="px-4 py-2 text-center"><button onclick="toggleDelivered('${sid}')" class="${s.delivered ? 'text-blue-600' : 'text-gray-300 hover:text-gray-400'}" title="Entregue"><i class="fas fa-truck"></i></button></td><td class="px-4 py-2 text-center"><button onclick="deleteSale('${sid}')" class="text-gray-400 hover:text-red-600"><i class="fas fa-trash-alt"></i></button></td></tr>`; }); h += `</tbody></table></div></div>`; c.insertAdjacentHTML('beforeend', h);
                });
            }
        }

        // --- NEW FUNC: RECALC SALE COST ---
        function renderSaleFilamentOptions() {
            const dropdown = document.getElementById('saleFilament');
            dropdown.innerHTML = '<option value="">Selecione o filamento...</option>';
            filaments.forEach(f => {
                const option = document.createElement('option');
                option.value = f.id;
                option.textContent = `${f.name} (${formatMoney(f.price)}/kg)`;
                dropdown.appendChild(option);
            });
            // Add default fallback option if global setting exists
            if (settings.filamentPrice) {
                const option = document.createElement('option');
                option.value = 'default';
                option.textContent = `Padrão (${formatMoney(settings.filamentPrice)}/kg)`;
                dropdown.appendChild(option);
            }
        }

        function recalcSaleCost() {
            const prodId = document.getElementById('productDropdown').value;
            const filamentId = document.getElementById('saleFilament').value;
            const preview = document.getElementById('saleCostPreview');
            const hiddenCost = document.getElementById('calculatedSaleCost');
            const hiddenEnergy = document.getElementById('calculatedSaleEnergy');
            const variationSelect = document.getElementById('saleVariation');
            const variationId = variationSelect ? variationSelect.value : "";

            const prod = products.find(p => p.id == prodId);
            if (!prod) {
                preview.textContent = "Custo: R$ 0,00";
                hiddenCost.value = 0;
                hiddenEnergy.value = 0;
                return;
            }

            // Determine Weight/Time source (Main or Variation)
            let weight = parseFloat(prod.weight) || 0;
            let timeH = parseFloat(prod.timeH) || 0;
            let timeM = parseFloat(prod.timeM) || 0;

            if (variationId && prod.variations) {
                const variant = prod.variations.find(v => v.id === variationId);
                if (variant) {
                    weight = parseFloat(variant.weight) || 0;
                    timeH = parseFloat(variant.timeH) || 0;
                    timeM = parseFloat(variant.timeM) || 0;
                }
            }

            let filPrice = parseFloat(settings.filamentPrice) || 0; // Default global

            if (filamentId && filamentId !== 'default') {
                const f = filaments.find(fi => fi.id == filamentId);
                if (f) filPrice = f.price;
            }

            const enPrice = parseFloat(settings.energyRate) || 0;
            const power = parseFloat(settings.printerPower) || 0;

            const matCost = (filPrice / 1000) * weight;
            const hours = timeH + (timeM / 60);
            const enCost = ((enPrice * power) / 1000) * hours;
            const totalCost = matCost + enCost;

            // If model has no weight data (legacy), fallback to registered cost
            if (weight === 0 && timeH === 0 && timeM === 0 && !variationId) {
                const legacyCost = parseFloat(prod.cost) || 0;
                preview.textContent = `Custo (Fixo): ${formatMoney(legacyCost)}`;
                hiddenCost.value = legacyCost;
                hiddenEnergy.value = parseFloat(prod.energyCost) || 0;
            } else {
                preview.textContent = `Custo: ${formatMoney(totalCost)}`;
                hiddenCost.value = totalCost.toFixed(2);
                hiddenEnergy.value = enCost.toFixed(4);
            }
        }

        function updateSaleInputFromVariation() {
            const prodId = document.getElementById('productDropdown').value;
            const varId = document.getElementById('saleVariation').value;
            const prod = products.find(p => p.id == prodId);

            if (prod) {
                if (varId && prod.variations) {
                    const variant = prod.variations.find(v => v.id === varId);
                    if (variant) {
                        document.getElementById('finalSalePrice').value = parseFloat(variant.price).toFixed(2);
                        document.getElementById('selectedVariationName').value = variant.name;
                    }
                } else {
                    document.getElementById('finalSalePrice').value = (parseFloat(prod.price) || 0).toFixed(2);
                    document.getElementById('selectedVariationName').value = "";
                }
                recalcSaleCost(); // Recalculate based on new weight/time
            }
        }

        function addSale() {
            const id = document.getElementById('productDropdown').value;
            const fp = parseFloat(document.getElementById('finalSalePrice').value);
            const qty = parseInt(document.getElementById('saleQty').value);
            const cus = document.getElementById('saleCustomer').value.trim();
            const filId = document.getElementById('saleFilament').value;
            const calcCost = parseFloat(document.getElementById('calculatedSaleCost').value);
            const calcEnergy = parseFloat(document.getElementById('calculatedSaleEnergy').value);
            const varName = document.getElementById('selectedVariationName').value;
            const varId = document.getElementById('saleVariation').value;

            if (!id || isNaN(fp)) { alert("Selecione produto/preço"); return; }
            if (isNaN(qty) || qty < 1) { alert("Qtd inválida"); return; }

            const p = products.find(x => x.id == id); if (!p) { alert("Produto não encontrado"); return; }

            const finalCost = calcCost > 0 ? calcCost : (parseFloat(p.cost) || 0);
            const finalEnergy = calcEnergy > 0 ? calcEnergy : (parseFloat(p.energyCost) || 0);

            const s = {
                id: Date.now(),
                name: p.name,
                cost: finalCost,
                price: fp,
                qty: qty,
                customer: cus || "Consumidor Final",
                energyCost: finalEnergy,
                delivered: false,
                paid: false,
                status: 'waiting',
                date: new Date().toISOString(),
                filamentId: filId,
                variationName: varName
            };

            sales.push(s); saveData();

            // DEDUCT FILAMENT STOCK
            const targetFilamentId = filId !== 'default' ? filId : (p.filamentId || null);

            let weightToDeduct = 0;
            if (varId && p.variations) {
                const v = p.variations.find(v => v.id === varId);
                if (v) weightToDeduct = parseFloat(v.weight) || 0;
            } else {
                weightToDeduct = parseFloat(p.weight) || 0;
            }

            if (weightToDeduct > 0 && targetFilamentId) {
                const fix = filaments.findIndex(f => f.id == targetFilamentId);
                if (fix !== -1) {
                    filaments[fix].remainingWeight = Math.max(0, (filaments[fix].remainingWeight || filaments[fix].initialWeight) - (weightToDeduct * qty));
                    saveData();
                    renderFilamentsTable();
                }
            }

            renderSalesTable(); updateCustomerDatalist(); updateKPIs(); alert("Registrado!");
        }

        function updateSaleQty(id, d) { const s = sales.find(x => x.id == id); if (s) { const n = (parseInt(s.qty) || 1) + d; if (n > 0) { s.qty = n; saveData(); renderSalesTable(); updateKPIs(); } else if (confirm("Remover?")) deleteSale(id); } }
        function editSaleCustomer(id) { const s = sales.find(x => x.id == id); if (s) { const n = prompt("Nome:", s.customer); if (n !== null) { s.customer = n.trim() || "Consumidor Final"; saveData(); renderSalesTable(); updateCustomerDatalist(); } } }
        function toggleDelivered(id) { const s = sales.find(x => x.id == id); if (s) { s.delivered = !s.delivered; saveData(); renderSalesTable(); } }
        function togglePaid(id) { const s = sales.find(x => x.id == id); if (s) { s.paid = !s.paid; saveData(); renderSalesTable(); updateKPIs(); } }
        function deleteSale(id) { if (confirm("Excluir?")) { sales = sales.filter(x => x.id != id); saveData(); renderSalesTable(); updateKPIs(); updateCustomerDatalist(); } }

        function updateSaleInput() {
            const pId = document.getElementById('productDropdown').value;
            const p = products.find(x => x.id == pId);
            const d = document.getElementById('saleProductImg');
            const variationSelect = document.getElementById('saleVariation');

            // 1. Populate/Update Filament Dropdown
            renderSaleFilamentOptions();

            if (p) {
                document.getElementById('finalSalePrice').value = (parseFloat(p.price) || 0).toFixed(2);
                const t = (p.images && p.images[0]) || p.image;
                d.style.backgroundImage = t ? `url('${t}')` : 'none';

                // 2. Select default filament for this product
                const filSelect = document.getElementById('saleFilament');
                if (p.filamentId && filaments.some(f => f.id == p.filamentId)) {
                    filSelect.value = p.filamentId;
                } else {
                    filSelect.value = "default"; // or ""
                }

                // 3. Handle Variations
                variationSelect.innerHTML = '<option value="">Padrão</option>';
                document.getElementById('selectedVariationName').value = "";
                if (p.variations && p.variations.length > 0) {
                    variationSelect.classList.remove('hidden');
                    p.variations.forEach(v => {
                        const opt = document.createElement('option');
                        opt.value = v.id;
                        opt.textContent = `${v.name} (R$ ${parseFloat(v.price).toFixed(2)})`;
                        variationSelect.appendChild(opt);
                    });
                } else {
                    variationSelect.classList.add('hidden');
                }

                // 4. Trigger Cost Recalc
                recalcSaleCost();

            } else {
                d.style.backgroundImage = 'none';
                document.getElementById('saleCostPreview').textContent = "Custo: R$ 0,00";
                variationSelect.classList.add('hidden');
            }
        }

        function saveProduct() {
            const id = document.getElementById('editModelId').value; const name = document.getElementById('regProdName').value; const cost = parseFloat(document.getElementById('regProdCost').value); const price = parseFloat(document.getElementById('regProdPrice').value); const energyCost = parseFloat(document.getElementById('regProdEnergyCost').value) || 0; const w = parseFloat(document.getElementById('regProdWeight').value) || 0; const th = parseFloat(document.getElementById('regProdTimeH').value) || 0; const tm = parseFloat(document.getElementById('regProdTimeM').value) || 0; const fid = document.getElementById('regProdFilament').value;

            if (!name || isNaN(cost) || isNaN(price)) { alert("Preencha campos."); return; }

            const imgs = [...currentModelImages];
            const vars = [...currentVariations]; // Get current variations

            if (id) {
                const idx = products.findIndex(x => x.id == id); if (idx !== -1) { const old = products[idx]; const fImgs = (imgs.length > 0 || currentModelImagesLoaded) ? imgs : old.images; products[idx] = { ...old, name, cost, price, energyCost, images: fImgs, weight: w, timeH: th, timeM: tm, filamentId: fid, variations: vars }; sales.forEach(s => { if (s.name === old.name) { s.name = name; } }); }
            } else { products.push({ id: Date.now(), name, cost, price, energyCost, images: imgs, weight: w, timeH: th, timeM: tm, filamentId: fid, variations: vars }); }
            saveData(); resetModelForm(); renderModelsTable(); updateDropdown(); updateKPIs();
        }

        function editModel(id) {
            const p = products.find(x => x.id == id); if (!p) return;
            document.getElementById('regProdName').value = p.name; document.getElementById('regProdCost').value = p.cost; document.getElementById('regProdPrice').value = p.price; document.getElementById('regProdEnergyCost').value = p.energyCost || 0; document.getElementById('editModelId').value = p.id; document.getElementById('regProdWeight').value = p.weight || ""; document.getElementById('regProdTimeH').value = p.timeH || ""; document.getElementById('regProdTimeM').value = p.timeM || ""; if (p.filamentId) document.getElementById('regProdFilament').value = p.filamentId;
            currentModelImages = []; if (p.images && p.images.length > 0) currentModelImages = [...p.images]; else if (p.image) currentModelImages = [p.image];
            renderImagePreviewList(); currentModelImagesLoaded = true;

            // Load variations
            currentVariations = p.variations ? [...p.variations] : [];
            renderVariationsList();

            document.getElementById('formTitle').innerHTML = 'Editar'; document.getElementById('btnSaveModel').textContent = "Atualizar"; document.getElementById('btnCancelEdit').classList.remove('hidden'); switchTab('models');
        }
        function deleteModel(id) { if (confirm("Excluir?")) { products = products.filter(x => x.id != id); saveData(); renderModelsTable(); updateDropdown(); } }
        function resetModelForm() {
            ['regProdName', 'regProdCost', 'regProdPrice', 'regProdEnergyCost', 'displayEnergyCost', 'regProdWeight', 'regProdTimeH', 'regProdTimeM', 'regProdFilament', 'editModelId', 'modelImageInput', 'modelImageBase64'].forEach(i => document.getElementById(i).value = '');
            currentModelImages = []; renderImagePreviewList(); currentModelImagesLoaded = false;
            currentVariations = []; renderVariationsList();
            document.getElementById('formTitle').innerHTML = 'Novo'; document.getElementById('btnSaveModel').textContent = "Cadastrar"; document.getElementById('btnCancelEdit').classList.add('hidden'); document.getElementById('calcPreviewCost').value = 'R$ 0,00'; document.getElementById('calcPreviewEnergy').value = 'R$ 0,00';
        }

        function calculateCost() {
            const w = parseFloat(document.getElementById('calcWeight').value) || 0; const h = parseFloat(document.getElementById('timeH').value) || 0; const m = parseFloat(document.getElementById('timeM').value) || 0; const s = parseFloat(document.getElementById('timeS').value) || 0; const fid = document.getElementById('calcFilamentSelect').value;
            let fp = parseFloat(settings.filamentPrice) || 0; if (fid && fid !== 'default') { const f = filaments.find(x => x.id == fid); if (f) fp = f.price; }
            const ep = parseFloat(settings.energyRate) || 0; const pow = parseFloat(settings.printerPower) || 0;
            const mat = (fp / 1000) * w; const hrs = h + (m / 60) + (s / 3600); const en = ((ep * pow) / 1000) * hrs; const tot = mat + en;
            document.getElementById('displayTotalCost').textContent = formatMoney(tot); document.getElementById('displaySuggestedPrice').textContent = formatMoney(tot * 2);
            return { total: tot, energy: en };
        }
        function transferCostToModel() { const d = calculateCost(); if (d.total <= 0) { alert("Simule primeiro"); return; } switchTab('models'); resetModelForm(); document.getElementById('regProdCost').value = d.total.toFixed(2); document.getElementById('regProdEnergyCost').value = d.energy.toFixed(4); document.getElementById('displayEnergyCost').value = d.energy.toFixed(4); document.getElementById('regProdWeight').value = document.getElementById('calcWeight').value; document.getElementById('regProdTimeH').value = document.getElementById('timeH').value; document.getElementById('regProdTimeM').value = document.getElementById('timeM').value; if (document.getElementById('calcFilamentSelect').value) document.getElementById('regProdFilament').value = document.getElementById('calcFilamentSelect').value; document.getElementById('regProdName').focus(); calculateModelFormCost(); }
        function saveConfig() { const f = document.getElementById('cfgFilament'); if (f) settings.filamentPrice = f.value; settings.energyRate = document.getElementById('cfgEnergy').value; settings.printerPower = document.getElementById('cfgPower').value; saveData(); }
        function updateKPIs() {
            const paid = sales.filter(s => s.paid); let rev = 0; let cost = 0; let items = 0; let en = 0;
            paid.forEach(s => { const q = parseInt(s.qty) || 1; rev += (parseFloat(s.price) || 0) * q; cost += (parseFloat(s.cost) || 0) * q; items += q; });
            sales.forEach(s => { const q = parseInt(s.qty) || 1; en += (parseFloat(s.energyCost) || 0) * q; });
            const prof = rev - cost; const kwh = en / (parseFloat(settings.energyRate) || 1);
            document.getElementById('kpiRevenue').textContent = formatMoney(rev); document.getElementById('kpiCost').textContent = formatMoney(cost); document.getElementById('kpiProfit').textContent = formatMoney(prof); document.getElementById('kpiCount').textContent = items; document.getElementById('kpiEnergy').textContent = formatMoney(en); document.getElementById('kpiEnergyKwh').textContent = kwh.toFixed(1) + " kWh"; document.getElementById('totalProfitDisplay').textContent = formatMoney(prof);
            updateCharts(rev, cost, prof, paid);
        }
        function updateCharts(r, c, p, paid) { if (typeof Chart === 'undefined') return; const ctx1 = document.getElementById('chartFinance').getContext('2d'); if (chartFinanceInstance) chartFinanceInstance.destroy(); chartFinanceInstance = new Chart(ctx1, { type: 'doughnut', data: { labels: ['Lucro', 'Custos'], datasets: [{ data: [p > 0 ? p : 0, c], backgroundColor: ['#10b981', '#ef4444'] }] }, options: { maintainAspectRatio: false } }); const cnt = {}; paid.forEach(s => { const n = s.name || "Desc."; const q = parseInt(s.qty) || 1; cnt[n] = (cnt[n] || 0) + q; }); const srt = Object.entries(cnt).sort((a, b) => b[1] - a[1]).slice(0, 5); const ctx2 = document.getElementById('chartProducts').getContext('2d'); if (chartProductsInstance) chartProductsInstance.destroy(); chartProductsInstance = new Chart(ctx2, { type: 'bar', data: { labels: srt.map(i => i[0]), datasets: [{ label: 'Qtd', data: srt.map(i => i[1]), backgroundColor: '#3b82f6' }] }, options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } }); }
        function recalculateEnergyHistory() { if (!confirm("Atualizar histórico?")) return; let c = 0; sales.forEach(s => { const p = products.find(x => x.name === s.name); if (p && p.energyCost) { s.energyCost = parseFloat(p.energyCost); c++; } }); saveData(); updateKPIs(); alert("Atualizado: " + c); }
        function saveData() { localStorage.setItem('3d_products', JSON.stringify(products)); localStorage.setItem('3d_sales', JSON.stringify(sales)); localStorage.setItem('3d_filaments', JSON.stringify(filaments)); localStorage.setItem('3d_settings', JSON.stringify(settings)); if (cloudUrl) syncToCloud(true); }
        async function syncToCloud(a) { if (!cloudUrl) return; updateCloudStatus('saving'); try { await fetch(cloudUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ action: "save", data: { products, sales, settings, filaments } }) }); updateCloudStatus('saved'); if (!a) alert("Salvo!"); } catch (e) { console.error(e); updateCloudStatus('error'); } }
        async function syncFromCloud(a) { if (!cloudUrl) { if (!a) alert("Sem URL"); return; } if (!a) showLoading("Baixando..."); try { const r = await fetch(cloudUrl + "?action=load&t=" + Date.now()); if (!r.ok) throw new Error("Erro na rede"); const j = await r.json(); if (j.data) { products = j.data.products || []; sales = j.data.sales || []; filaments = j.data.filaments || []; if (j.data.settings) settings = j.data.settings; saveData(); refreshUI(); if (!a) alert("Ok!"); } } catch (e) { console.error(e); if (!a) alert("Erro ao sincronizar. Verifique a URL."); } finally { hideLoading(); } }
        function switchTab(id) { document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden')); document.getElementById('view-' + id).classList.remove('hidden'); document.querySelectorAll('nav button').forEach(b => { b.classList.remove('tab-active'); b.classList.add('tab-inactive'); }); document.getElementById('tab-' + id).classList.add('tab-active'); document.getElementById('tab-' + id).classList.remove('tab-inactive'); if (id === 'dashboard') updateKPIs(); if (id === 'sales') calculateCost(); }
        function formatMoney(v) { return (parseFloat(v) || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        function updateCloudStatus(s) { const e = document.getElementById('cloudStatus'); if (s === 'saving') e.innerHTML = '<i class="fas fa-sync fa-spin text-blue-500"></i> Salvando...'; else if (s === 'saved') e.innerHTML = '<i class="fas fa-check-circle text-green-500"></i> Salvo'; else if (s === 'error') e.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500"></i> Erro'; else e.innerHTML = '<i class="fas fa-hdd"></i> Local'; }
        function showLoading(t) { document.getElementById('loadingText').innerText = t; document.getElementById('loadingOverlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }
        function exportData() { const s = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ products, sales, settings, filaments })); const a = document.createElement('a'); a.href = s; a.download = "backup_3d.json"; a.click(); }
        function importData() { const f = document.getElementById('importFile').files[0]; if (!f) return; const r = new FileReader(); r.onload = function (e) { const d = JSON.parse(e.target.result); if (d.products) { products = d.products; sales = d.sales; settings = d.settings; filaments = d.filaments || []; saveData(); refreshUI(); alert("Restaurado!"); } }; r.readAsText(f); }
        function clearAllData() { if (confirm("Apagar tudo?")) { localStorage.clear(); location.reload(); } }
    </script>
</body>

</html>